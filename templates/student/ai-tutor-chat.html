{% load static %}




<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Tutor Chat - AI Study Platform</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Custom CSS -->
    <!-- <link rel="stylesheet" href="dashboard-styles.css"> -->
     <link rel="stylesheet" href="{% static 'dashboard-styles.css' %}">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f7f7f8;
            color: #343541;
            height: 100vh;
            overflow: hidden;
        }
        
        .chat-layout {
            display: flex;
            height: 100vh;
            padding-top: 60px;
        }
        
        .sidebar {
            width: 260px;
            background: #202123;
            color: #ececf1;
            padding: 1rem;
            overflow-y: auto;
            border-right: 1px solid #4d4d4f;
        }
        
        .new-chat-btn {
            width: 100%;
            background: transparent;
            border: 1px solid #565869;
            color: #ececf1;
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .new-chat-btn:hover {
            background: #2a2b32;
            border-color: #767676;
        }
        
        .chat-history {
            margin-bottom: 2rem;
        }
        
        .chat-history h6 {
            color: #8e8ea0;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.75rem;
            font-weight: 600;
        }
        
        .history-item {
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 0.25rem;
            cursor: pointer;
            transition: background 0.2s ease;
            font-size: 0.875rem;
            color: #ececf1;
        }
        
        .history-item:hover {
            background: #2a2b32;
        }
        
        .history-item.active {
            background: #343541;
        }
        
        .main-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #ffffff;
        }
        
        .chat-header {
            background: #ffffff;
            border-bottom: 1px solid #e5e5e5;
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .tutor-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .tutor-avatar {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.875rem;
        }
        
        .tutor-details h5 {
            margin: 0;
            font-size: 1rem;
            font-weight: 600;
            color: #343541;
        }
        
        .tutor-status {
            font-size: 0.75rem;
            color: #10a37f;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .status-dot {
            width: 6px;
            height: 6px;
            background: #10a37f;
            border-radius: 50%;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem 0;
        }
        
        .message-group {
            max-width: 768px;
            margin: 0 auto;
            padding: 0 1rem;
        }
        
        .message {
            display: flex;
            gap: 1rem;
            padding: 1.5rem 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .message:last-child {
            border-bottom: none;
        }
        
        .message-avatar {
            width: 30px;
            height: 30px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            flex-shrink: 0;
        }
        
        .message.user .message-avatar {
            background: #19c37d;
            color: white;
        }
        
        .message.ai .message-avatar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .message-content {
            flex: 1;
            line-height: 1.6;
        }
        
        .message-content p {
            margin: 0 0 1rem 0;
        }
        
        .message-content p:last-child {
            margin-bottom: 0;
        }
        
        .quick-suggestions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.75rem;
            margin-top: 1rem;
        }
        
        .suggestion-btn {
            padding: 0.75rem 1rem;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            background: #f9f9f9;
            color: #343541;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.875rem;
        }
        
        .suggestion-btn:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }
        
        .typing-indicator {
            display: none;
            padding: 1.5rem 1rem;
            max-width: 768px;
            margin: 0 auto;
        }
        
        .typing-content {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .typing-dots {
            display: flex;
            gap: 4px;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            background: #8e8ea0;
            border-radius: 50%;
            animation: typingAnimation 1.4s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes typingAnimation {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }
        
        .chat-input-section {
            border-top: 1px solid #e5e5e5;
            background: #ffffff;
            padding: 1rem;
        }
        
        .input-container {
            max-width: 768px;
            margin: 0 auto;
            position: relative;
        }
        
        .input-wrapper {
            position: relative;
            background: #ffffff;
            border: 1px solid #d1d5db;
            border-radius: 12px;
            overflow: hidden;
            transition: border-color 0.2s ease;
        }
        
        .input-wrapper:focus-within {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .chat-input {
            width: 100%;
            border: none;
            outline: none;
            padding: 1rem 3rem 1rem 1rem;
            font-size: 1rem;
            line-height: 1.5;
            background: transparent;
            resize: none;
            max-height: 120px;
            min-height: 24px;
        }
        
        .send-button {
            position: absolute;
            right: 0.5rem;
            bottom: 0.5rem;
            width: 32px;
            height: 32px;
            background: #10a37f;
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s ease;
        }
        
        .send-button:hover:not(:disabled) {
            background: #0d8f6b;
        }
        
        .send-button:disabled {
            background: #d1d5db;
            cursor: not-allowed;
        }
        
        .input-hint {
            text-align: center;
            font-size: 0.75rem;
            color: #8e8ea0;
            margin-top: 0.5rem;
        }
        
        /* Speech Controls */
        .speech-controls {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
            padding-top: 0.5rem;
            border-top: 1px solid #e5e5e5;
        }
        
        .speech-btn {
            background: none;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 0.375rem 0.75rem;
            color: #6b7280;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.375rem;
        }
        
        .speech-btn:hover {
            background: #f3f4f6;
            border-color: #9ca3af;
            color: #374151;
        }
        
        .speech-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
            color: white;
        }
        
        .speech-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .speech-settings {
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid #e5e5e5;
            display: none;
        }
        
        .speech-settings.show {
            display: block;
        }
        
        .speech-setting-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }
        
        .speech-setting-row label {
            color: #6b7280;
            min-width: 60px;
        }
        
        .speech-setting-row input,
        .speech-setting-row select {
            flex: 1;
            padding: 0.25rem 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 0.875rem;
        }
        
        /* Scrollbar styles */
        .chat-messages::-webkit-scrollbar,
        .sidebar::-webkit-scrollbar {
            width: 4px;
        }
        
        .chat-messages::-webkit-scrollbar-track,
        .sidebar::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .chat-messages::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 2px;
        }
        
        .sidebar::-webkit-scrollbar-thumb {
            background: #565869;
            border-radius: 2px;
        }
        
        /* Dark mode */
        body.dark-mode {
            background: #343541;
            color: #ececf1;
        }
        
        body.dark-mode .main-chat {
            background: #343541;
        }
        
        body.dark-mode .chat-header {
            background: #343541;
            border-bottom-color: #565869;
        }
        
        body.dark-mode .tutor-details h5 {
            color: #ececf1;
        }
        
        body.dark-mode .message {
            border-bottom-color: #565869;
        }
        
        body.dark-mode .suggestion-btn {
            background: #40414f;
            border-color: #565869;
            color: #ececf1;
        }
        
        body.dark-mode .suggestion-btn:hover {
            border-color: #667eea;
            background: #4c4d5f;
        }
        
        body.dark-mode .chat-input-section {
            background: #343541;
            border-top-color: #565869;
        }
        
        body.dark-mode .input-wrapper {
            background: #40414f;
            border-color: #565869;
        }
        
        body.dark-mode .chat-input {
            background: transparent;
            color: #ececf1;
        }
        
        body.dark-mode .chat-input::placeholder {
            color: #8e8ea0;
        }
        
        body.dark-mode .speech-controls {
            border-top-color: #565869;
        }
        
        body.dark-mode .speech-btn {
            background: #40414f;
            border-color: #565869;
            color: #ececf1;
        }
        
        body.dark-mode .speech-btn:hover {
            background: #4c4d5f;
            border-color: #667eea;
        }
        
        body.dark-mode .speech-settings {
            border-top-color: #565869;
        }
        
        body.dark-mode .speech-setting-row label {
            color: #ececf1;
        }
        
        body.dark-mode .speech-setting-row input,
        body.dark-mode .speech-setting-row select {
            background: #40414f;
            border-color: #565869;
            color: #ececf1;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }
            
            .chat-layout {
                padding-top: 60px;
            }
            
            .message-group,
            .input-container {
                padding: 0 1rem;
            }
        }
    </style>
</head>
<body>


            <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>


    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="student-dashboard.html">
                <i class="fas fa-graduation-cap me-2"></i>
                AI Study Platform
            </a>
            
            <div class="navbar-nav ms-auto">
                <div class="nav-item me-3">
                    <a class="nav-link" href="#" title="Toggle Dark Mode" onclick="toggleDarkMode()">
                        <i class="fas fa-moon text-light" id="darkModeToggle"></i>
                    </a>
                </div>
                <div class="nav-item">
                    <a class="nav-link" href="student-dashboard.html">
                        <i class="fas fa-arrow-left me-1"></i>Back to Dashboard
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="chat-layout">
        <!-- Sidebar -->
        <div class="sidebar">
            <button class="new-chat-btn" onclick="clearChat()">
                <i class="fas fa-plus"></i>
                New conversation
            </button>
            
           
            
            <div class="mt-auto">
               
                
                <button class="btn btn-outline-light btn-sm w-100 mb-2" onclick="exportChat()">
                    <i class="fas fa-download me-1"></i>Export Chat
                </button>
            </div>
        </div>

        <!-- Main Chat Area -->
        <div class="main-chat">
            <!-- Chat Header -->
            <div class="chat-header">
                <div class="tutor-info">
                    <div class="tutor-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="tutor-details">
                        <h5>AI Tutor Assistant</h5>
                        <div class="tutor-status">
                            <div class="status-dot"></div>
                            Online • Ready to help
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chat Messages -->
            <div class="chat-messages" id="chatMessages">
                <div class="message-group">
                    <!-- Welcome Message -->
                    <div class="message ai">
                        <div class="message-avatar">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div class="message-content">
                            <p>Hello! 👋 I'm your AI tutor assistant. I'm here to help you with your studies across various subjects.  What would you like to learn about today?</p>
                            
                           
                            <p></p>
                            
                            <div class="quick-suggestions">
                              
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Typing Indicator -->
            <div class="typing-indicator" id="typingIndicator">
                <div class="message-group">
                    <div class="typing-content">
                        <div class="message-avatar" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div class="typing-dots">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chat Input -->
            <div class="chat-input-section">
                <div class="input-container">
                    <div class="input-wrapper">
                        <textarea 
                            class="chat-input" 
                            id="chatInput" 
                            placeholder="Message AI Tutor..."
                            rows="1"
                            onkeydown="handleKeyPress(event)"
                            oninput="adjustTextareaHeight(this)"
                        ></textarea>
                        <button class="send-button" id="sendButton" onclick="sendMessage()">
                            <i class="fas fa-arrow-up"></i>
                        </button>
                    </div>
                    <div class="input-hint">
                        AI Tutor can make mistakes. Check important info and verify solutions.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Chat functionality
        let chatHistory = [];
        let isTyping = false;

        // Sample AI responses for different subjects
        const aiResponses = {
            mathematics: [
                "Great question about mathematics! Let me break this down step by step...",
                "In mathematics, this concept relates to fundamental principles. Here's how to approach it...",
                "Let's solve this systematically. First, identify what we know and what we need to find..."
            ],
            physics: [
                "Physics is fascinating! This principle explains how the natural world works...",
                "Let's apply the fundamental laws of physics to understand this better...",
                "Good question! In physics, we need to consider the forces and energy involved..."
            ],
            programming: [
                "Programming is all about breaking problems into smaller, manageable parts...",
                "Here's the code structure you'll need, along with explanations for each part...",
                "Great programming question! Let's debug this step by step..."
            ],
            general: [
                "That's an excellent question! Let me provide you with a comprehensive explanation...",
                "I'd be happy to help you understand this concept better...",
                "Here's what you need to know about this topic..."
            ]
        };

        
        //    below one is the main function
        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            try {
                // Add user message
                addUserMessage(message);
                input.value = '';
                adjustTextareaHeight(input);
                
                // Show typing indicator and generate AI response
                showTypingIndicator();
                
                // Use a more reliable timeout mechanism
                // const timeoutId = setTimeout(() => {
                //     console.log('Timeout callback executing for message:', message);
                //     generateAIResponse(message);
                // }, 2000); // Fixed 2 second delay for more predictable behavior

                generateAIResponse(message);




                
            } catch (error) {
                console.error('Error sending message:', error);
                hideTypingIndicator();
            }
        }

        function sendQuickQuestion(question) {
            try {
                addUserMessage(question);
                showTypingIndicator();
                
                const timeoutId = setTimeout(() => {
                    console.log('Timeout callback executing for quick question:', question);
                    generateAIResponse(question);
                }, 2000);
                
            } catch (error) {
                console.error('Error sending quick question:', error);
                hideTypingIndicator();
            }
        }

        function addUserMessage(message) {
            const chatMessages = document.getElementById('chatMessages');
            const messageGroup = document.createElement('div');
            messageGroup.className = 'message-group';
            
            messageGroup.innerHTML = `
                <div class="message user">
                    <div class="message-content">
                        ${message}
                    </div>
                    <div class="message-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                </div>
            `;
            
            chatMessages.appendChild(messageGroup);
            scrollToBottom();
            
            // Add to chat history
            chatHistory.push({ content: message, sender: 'user', time: new Date().toLocaleTimeString() });
        }

        function addAIMessage(message) {
            const chatMessages = document.getElementById('chatMessages');
            const messageGroup = document.createElement('div');
            messageGroup.className = 'message-group';
            
            const messageId = 'msg_' + Date.now();
            
            messageGroup.innerHTML = `
                <div class="message ai">
                    <div class="message-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="message-content">
                        <div id="${messageId}" style="white-space: pre;">${message.response}</div>
                        <div class="speech-controls">
                            <button class="speech-btn" onclick="speakMessage('${messageId}')" title="Listen to this message">
                                <i class="fas fa-volume-up"></i>
                                Listen
                            </button>
                            
                           
                            <button class="speech-btn" onclick="toggleSpeechSettings()" title="Speech settings">
                                <i class="fas fa-cog"></i>
                                Settings
                            </button>
                        </div>
                        <div class="speech-settings" id="speechSettings">
                            <div class="speech-setting-row">
                                <label>Rate:</label>
                                <input type="range" id="speechRate" min="0.5" max="2" step="0.1" value="1">
                                <span id="rateValue">1x</span>
                            </div>
                            <div class="speech-setting-row">
                                <label>Pitch:</label>
                                <input type="range" id="speechPitch" min="0" max="2" step="0.1" value="1">
                                <span id="pitchValue">1x</span>
                            </div>
                            <div class="speech-setting-row">
                                <label>Voice:</label>
                                <select id="voiceSelect">
                                    <option value="">Default</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            chatMessages.appendChild(messageGroup);
            scrollToBottom();
            
            // Add to chat history
            chatHistory.push({ content: message, sender: 'ai', time: new Date().toLocaleTimeString() });
        }

        function showTypingIndicator() {
            isTyping = true;
            document.getElementById('typingIndicator').style.display = 'block';
            document.getElementById('sendButton').disabled = true;
            scrollToBottom();
            
            // Safety timeout to hide typing indicator after 10 seconds max
            setTimeout(() => {
                if (isTyping) {
                    console.warn('Typing indicator timeout - forcing hide');
                    hideTypingIndicator();
                }
            }, 10000);
        }

        function hideTypingIndicator() {
            console.log('Hiding typing indicator');
            isTyping = false;
            document.getElementById('typingIndicator').style.display = 'none';
            document.getElementById('sendButton').disabled = false;
        }

        function scrollToBottom() {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function adjustTextareaHeight(textarea) {
            textarea.style.height = '20px';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }

        async function generateAIResponse(userMessage) {
            // console.log('=== Starting AI Response Generation ===');
            // console.log('User message:', userMessage);
            
            try {

                   async function am(){

                         try{


                               const responce = await $.ajax({

                                        url: "{% url 'stu:contentClarifier' %}",
                                        type: 'POST',
                                        data: {
                                            'mess': userMessage,
                                            'csrfmiddlewaretoken': '{{ csrf_token }}'
                                        },
                                    });


                                    return responce;





                         } catch(error){
                                    console.error('Sorry we facing problem in backend', error);
                         }

                   }

                
                   const res_mess = await am();





                // Simple test - just return a basic response
                // let response = `Thank you for your question: "${userMessage}". I'm here to help you learn!`;
                let responce = res_mess;

                console.log(responce)
                
                // console.log('Generated response:', response);
                // console.log('Calling hideTypingIndicator...');
                hideTypingIndicator();
                
                // console.log('Calling addAIMessage...');
                addAIMessage(responce);
                
                // console.log('=== AI Response Generation Completed Successfully ===');
                
            } catch (error) {
                console.error('=== ERROR in AI Response Generation ===');
                console.error('Error:', error);
                console.error('Error stack:', error.stack);
                hideTypingIndicator();
                addAIMessage('Sorry, I encountered an error while processing your message. Please try again.');
            }
        }

        function generateContextualResponse(message, subject) {
            try {
                console.log('Generating contextual response for message:', message, 'subject:', subject);
                const lowerMessage = message.toLowerCase();
                
                // Math-related responses
                if (lowerMessage.includes('calculus') || lowerMessage.includes('derivative')) {
                    return `Great question about calculus! Derivatives measure the rate of change of a function. Think of it as the slope of a curve at any given point. For example, if f(x) = x², then f'(x) = 2x. This means at x = 3, the rate of change is 6. Would you like me to explain the power rule or chain rule next?`;
                }
                
                if (lowerMessage.includes('physics') || lowerMessage.includes('force')) {
                    return `Physics is all about understanding how things move and interact! Newton's laws are fundamental: 1) Objects at rest stay at rest unless acted upon, 2) F = ma (force equals mass times acceleration), 3) Every action has an equal and opposite reaction. What specific physics concept would you like to explore?`;
                }
                
                if (lowerMessage.includes('programming') || lowerMessage.includes('code')) {
                    return `Programming is like solving puzzles with logic! Start with understanding the problem, break it into smaller steps, then write code for each step. Key concepts include variables (store data), functions (reusable code blocks), and loops (repeat actions). What programming language are you working with?`;
                }
                
                if (lowerMessage.includes('study tips') || lowerMessage.includes('study')) {
                    return `Excellent question about studying! Here are proven techniques: 1) **Spaced Repetition** - review material at increasing intervals, 2) **Active Recall** - test yourself instead of just re-reading, 3) **Pomodoro Technique** - 25-minute focused sessions with breaks, 4) **Teach Others** - explaining concepts solidifies understanding. Which technique interests you most?`;
                }
                
                if (lowerMessage.includes('practice') || lowerMessage.includes('problems')) {
                    return `Practice problems are crucial for mastering concepts! I can generate custom problems based on your level. For ${subject}, I'd recommend starting with fundamentals and gradually increasing difficulty. Would you like me to create some practice questions for you right now?`;
                }
                
                // Default contextual response
                return `I understand you're asking about "${message}". This is a great topic to explore! Based on your question, I can help you break this down into manageable concepts. The key is to start with the fundamentals and build up your understanding step by step. What specific aspect would you like me to focus on first?`;
            } catch (error) {
                console.error('Error in generateContextualResponse:', error);
                return `Thank you for your question about "${message}". I'd be happy to help you understand this better. Could you provide a bit more detail about what specific aspect you'd like me to focus on?`;
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function clearChat() {
            if (confirm('Are you sure you want to clear the chat history?')) {
                const welcomeMessageId = 'msg_welcome_' + Date.now();
                document.getElementById('chatMessages').innerHTML = `
                    <div class="message-group">
                        <div class="message ai">
                            <div class="message-avatar">
                                <i class="fas fa-robot"></i>
                            </div>
                            <div class="message-content">
                                <div id="${welcomeMessageId}">
                                    <p>Hello! 👋 I'm your AI tutor assistant. I'm here to help you with your studies across various subjects.</p>
                                    <p>I can help you with:</p>
                                    <ul>
                                        <li>📚 Explaining complex concepts step by step</li>
                                        <li>🧮 Solving math and physics problems</li>
                                        <li>💻 Programming guidance and debugging</li>
                                        <li>📝 Study strategies and exam preparation</li>
                                        <li>🔬 Science experiments and theories</li>
                                    </ul>
                                    <p>What would you like to learn about today?</p>
                                    
                                    <div class="quick-suggestions">
                                        <button class="suggestion-btn" onclick="sendQuickQuestion('Explain calculus derivatives with examples')">
                                            📊 Calculus derivatives explained
                                        </button>
                                        <button class="suggestion-btn" onclick="sendQuickQuestion('Help me understand Newton\\'s laws of motion')">
                                            🌌 Newton's laws of motion
                                        </button>
                                        <button class="suggestion-btn" onclick="sendQuickQuestion('Teach me Python programming basics')">
                                            🐍 Python programming basics
                                        </button>
                                        <button class="suggestion-btn" onclick="sendQuickQuestion('Best study techniques for better retention')">
                                            📖 Effective study techniques
                                        </button>
                                    </div>
                                </div>
                                <div class="speech-controls">
                                    <button class="speech-btn" onclick="speakMessage('${welcomeMessageId}')" title="Listen to this message">
                                        <i class="fas fa-volume-up"></i>
                                        Listen
                                    </button>
                                    <button class="speech-btn" onclick="pauseSpeech()" title="Pause speech">
                                        <i class="fas fa-pause"></i>
                                        Pause
                                    </button>
                                    <button class="speech-btn" onclick="stopSpeech()" title="Stop speech">
                                        <i class="fas fa-stop"></i>
                                        Stop
                                    </button>
                                    <button class="speech-btn" onclick="toggleSpeechSettings()" title="Speech settings">
                                        <i class="fas fa-cog"></i>
                                        Settings
                                    </button>
                                </div>
                                <div class="speech-settings" id="speechSettings">
                                    <div class="speech-setting-row">
                                        <label>Rate:</label>
                                        <input type="range" id="speechRate" min="0.5" max="2" step="0.1" value="1">
                                        <span id="rateValue">1x</span>
                                    </div>
                                    <div class="speech-setting-row">
                                        <label>Pitch:</label>
                                        <input type="range" id="speechPitch" min="0" max="2" step="0.1" value="1">
                                        <span id="pitchValue">1x</span>
                                    </div>
                                    <div class="speech-setting-row">
                                        <label>Voice:</label>
                                        <select id="voiceSelect">
                                            <option value="">Default</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                chatHistory = [];
                
                // Reinitialize speech settings for the new welcome message
                setTimeout(() => {
                    loadVoices();
                    initSpeechSettings();
                }, 100);
            }
        }

        function exportChat() {
            if (chatHistory.length === 0) {
                alert('No chat history to export!');
                return;
            }
            
            let exportText = 'AI Tutor Chat History\n';
            exportText += '========================\n\n';
            
            chatHistory.forEach(msg => {
                exportText += `[${msg.time}] ${msg.sender.toUpperCase()}: ${msg.content}\n\n`;
            });
            
            const blob = new Blob([exportText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ai-tutor-chat-${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Text-to-Speech functionality
        let speechSynthesis = window.speechSynthesis;
        let currentUtterance = null;
        let availableVoices = [];

        // Speech functions
        function speakMessage(messageId) {
            const messageElement = document.getElementById(messageId);
            if (!messageElement) return;
            
            // Stop any current speech
            stopSpeech();
            
            // Get the text content and clean it
            let text = messageElement.innerText || messageElement.textContent;
            text = text.replace(/\*\*/g, ''); // Remove markdown bold markers
            text = text.replace(/\n\n/g, '. '); // Replace double newlines with periods
            
            if (!text.trim()) return;
            
            // Create utterance
            currentUtterance = new SpeechSynthesisUtterance(text);
            
            // Apply settings
            const rate = document.getElementById('speechRate')?.value || 1;
            const pitch = document.getElementById('speechPitch')?.value || 1;
            const voiceSelect = document.getElementById('voiceSelect');
            
            currentUtterance.rate = parseFloat(rate);
            currentUtterance.pitch = parseFloat(pitch);
            
            // Set voice if selected
            if (voiceSelect && voiceSelect.value) {
                const selectedVoice = availableVoices.find(voice => voice.name === voiceSelect.value);
                if (selectedVoice) {
                    currentUtterance.voice = selectedVoice;
                }
            }
            
            // Visual feedback
            const speakBtn = event.target.closest('.speech-btn');
            if (speakBtn) {
                speakBtn.classList.add('active');
                speakBtn.innerHTML = '<i class="fas fa-volume-up"></i> Speaking...';
            }
            
            // Event handlers
            currentUtterance.onend = function() {
                if (speakBtn) {
                    speakBtn.classList.remove('active');
                    speakBtn.innerHTML = '<i class="fas fa-volume-up"></i> Listen';
                }
                currentUtterance = null;
            };
            
            currentUtterance.onerror = function(event) {
                console.error('Speech synthesis error:', event);
                if (speakBtn) {
                    speakBtn.classList.remove('active');
                    speakBtn.innerHTML = '<i class="fas fa-volume-up"></i> Listen';
                }
                currentUtterance = null;
            };
            
            // Start speaking
            speechSynthesis.speak(currentUtterance);
        }

        function pauseSpeech() {
            if (speechSynthesis.speaking && !speechSynthesis.paused) {
                speechSynthesis.pause();
                updateSpeechButtons('paused');
            } else if (speechSynthesis.paused) {
                speechSynthesis.resume();
                updateSpeechButtons('speaking');
            }
        }

        function stopSpeech() {
            if (speechSynthesis.speaking || speechSynthesis.paused) {
                speechSynthesis.cancel();
                updateSpeechButtons('stopped');
                currentUtterance = null;
            }
        }

        function updateSpeechButtons(state) {
            const speakBtns = document.querySelectorAll('.speech-btn');
            speakBtns.forEach(btn => {
                if (btn.onclick && btn.onclick.toString().includes('speakMessage')) {
                    btn.classList.remove('active');
                    if (state === 'stopped') {
                        btn.innerHTML = '<i class="fas fa-volume-up"></i> Listen';
                    } else if (state === 'paused') {
                        btn.innerHTML = '<i class="fas fa-volume-up"></i> Paused';
                    } else if (state === 'speaking') {
                        btn.classList.add('active');
                        btn.innerHTML = '<i class="fas fa-volume-up"></i> Speaking...';
                    }
                }
            });
        }

        function toggleSpeechSettings() {
            const settings = document.getElementById('speechSettings');
            if (settings) {
                settings.classList.toggle('show');
            }
        }

        function loadVoices() {
            availableVoices = speechSynthesis.getVoices();
            const voiceSelect = document.getElementById('voiceSelect');
            
            if (voiceSelect && availableVoices.length > 0) {
                voiceSelect.innerHTML = '<option value="">Default</option>';
                availableVoices.forEach(voice => {
                    const option = document.createElement('option');
                    option.value = voice.name;
                    option.textContent = `${voice.name} (${voice.lang})`;
                    voiceSelect.appendChild(option);
                });
            }
        }

        // Load voices when available
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = loadVoices;
        }

        // Speech settings event handlers
        function initSpeechSettings() {
            // Rate slider
            const rateSlider = document.getElementById('speechRate');
            const rateValue = document.getElementById('rateValue');
            if (rateSlider && rateValue) {
                rateSlider.addEventListener('input', function() {
                    rateValue.textContent = this.value + 'x';
                });
            }

            // Pitch slider
            const pitchSlider = document.getElementById('speechPitch');
            const pitchValue = document.getElementById('pitchValue');
            if (pitchSlider && pitchValue) {
                pitchSlider.addEventListener('input', function() {
                    pitchValue.textContent = this.value + 'x';
                });
            }
        }

        // Dark mode toggle
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            const icon = document.getElementById('darkModeToggle');
            icon.className = isDark ? 'fas fa-sun text-light' : 'fas fa-moon text-light';
            localStorage.setItem('darkMode', isDark);
        }

        // Load dark mode preference
        document.addEventListener('DOMContentLoaded', function() {
            const darkMode = localStorage.getItem('darkMode') === 'true';
            if (darkMode) {
                document.body.classList.add('dark-mode');
                document.getElementById('darkModeToggle').className = 'fas fa-sun text-light';
            }
            
            // Focus on input
            document.getElementById('chatInput').focus();
            
            // Initialize speech functionality
            loadVoices();
            
            // Initialize speech settings after a short delay to ensure DOM is ready
            setTimeout(initSpeechSettings, 100);
        });

        // Auto-resize textarea
        document.getElementById('chatInput').addEventListener('input', function() {
            adjustTextareaHeight(this);
        });
    </script>
</body>
</html>